<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Panel Admin ‚Äî Notificaciones</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
    .reporteItem {
    animation: fadeInReport .4s ease;
}
@keyframes fadeInReport {
    from { opacity: 0; transform: translateY(-6px); }
    to   { opacity: 1; transform: translateY(0); }
}

    .reporteItem {
    padding: 8px 12px;
    margin-bottom: 6px;
    border-radius: 8px;
    background: rgba(255,255,255,0.1);
    border-left: 5px solid #ffc107;
}

.reporte-bingo { border-left-color: #28a745; }
.reporte-terna { border-left-color: #0dcaf0; }
.reporte-quintina { border-left-color: #d63384; }

.reporteItem small {
    opacity: 0.7;
    font-size: 12px;
}

body { background:#060d18; color:white; font-family:Arial, sans-serif; padding:18px; }
.containerBox{ background: rgba(255,255,255,0.07); padding:16px; border-radius:10px; margin-bottom:16px; border:1px solid rgba(255,255,255,0.12); }
h2{ margin-bottom:12px; color:#ffc107; text-shadow:0 0 8px rgba(255,193,7,0.15); }
.notif { background: rgba(0,0,0,0.45); padding:10px; border-radius:8px; margin-bottom:8px; display:flex; gap:8px; align-items:center; justify-content:space-between; }
.badgeTipo { min-width:86px; text-align:center; font-weight:bold; }
.btnSmall { padding:4px 8px; font-size:13px; }
</style>
</head>

<body>

<h2>Panel Admin ‚Äî Notificaciones</h2>

<div class="row">
  <div class="col-md-6">
    <div class="containerBox">
      <h5>√öltimos n√∫meros</h5>
      <div id="numerosAnim" style="display:flex; gap:12px; margin-top:10px;"></div>
      <div class="card mt-4">
    <div class="card-header bg-warning text-dark fw-bold">
        üì¢ Reportes en vivo (jugadores)
    </div>
    <div class="card-body" id="panelReportes" style="max-height:250px; overflow:auto;">
        <p class="text-muted">A√∫n no hay reportes...</p>
    </div>
</div>
      <div class="mt-3">
        <button class="btn btn-sm btn-primary" onclick="limpiarNotifs()">Limpiar notificaciones vistas</button>
      </div>
    </div>

    <div class="containerBox">
      <h5>Notificaciones entrantes</h5>
      <div id="notifsList"></div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="containerBox">
      <h5>Control Sorteo</h5>
      <div id="numeroActual" style="font-size:48px; font-weight:bold; color:#ffc107;">--</div>
      <div class="mt-2">
        <button class="btn btn-success btn-sm" onclick="sacarNumero()">Sacar n√∫mero</button>
        <button class="btn btn-warning btn-sm" onclick="reiniciarSorteo()">Reiniciar</button>
      </div>
    </div>

    <div class="containerBox">
      <h5>Jugadores con cartones</h5>
      <div id="conCartones"></div>
    </div>
  </div>
</div>


<!-- =============================================================
     JUGADORES EN ESPERA
============================================================= -->
<div class="col-md-12 mt-4">
    <div class="containerBox">
        <h5>Jugadores en espera</h5>
        <div id="jugadoresEspera"></div>
    </div>
</div>

<!-- =============================================================
     NUEVO PANEL: ASIGNAR CARTONES
============================================================= -->
<div class="col-md-12 mt-4">
    <div class="containerBox">
        <h5>Asignar cartones a jugadores aceptados</h5>
        <div id="aceptadosSinCartones"></div>
    </div>
</div>

<!-- =========================
   WEBSOCKET (admin)
   ========================= -->
<script>
// Conexi√≥n WebSocket din√°mica (funciona en Render)
const protocol = (location.protocol === "https:") ? "wss" : "ws";
const wsUrl = `${protocol}://${location.host}`;
const ws = new WebSocket(wsUrl);

ws.addEventListener("open", () => {
    // Nos identificamos como admin
    ws.send(JSON.stringify({ type: "admin-join" }));
});

// recibir mensajes
ws.addEventListener("message", (ev) => {
    let data;
    try { data = JSON.parse(ev.data); } catch(e){ return; }

    // Lista de jugadores conectados (viene del servidor)
    if (data.type === "player-list") {
        console.log("Jugadores conectados:", data.players);
        mostrarJugadoresConectados(Array.isArray(data.players) ? data.players : []);
    }

    // Reporte enviado por un jugador (Terna, Quintina, Bingo)
    if (data.type === "report") {
        agregarReporteEnVivo(data.report);
    }

    // Estado inicial
    if (data.type === "state") {
        // opcional: podr√≠as usar data.players / data.lastNumbers
        console.log("Estado inicial recibido:", data);
        if (Array.isArray(data.players)) mostrarJugadoresConectados(data.players);
        if (Array.isArray(data.lastNumbers) && data.lastNumbers.length) actualizarUltimosTresAdmin(data.lastNumbers);
    }

    // Nuevo n√∫mero del sorteo
    if (data.type === "number") {
        const n = data.number;
        localStorage.setItem("ultimoNumero", n);

        let arr = JSON.parse(localStorage.getItem("numerosSorteados") || "[]");
        if (!arr.includes(n)) arr.push(n);
        localStorage.setItem("numerosSorteados", JSON.stringify(arr));

        actualizarUltimosTresAdmin(arr);
        renderNotifs();
    }

    // Reinicio
    if (data.type === "reset") {
        localStorage.removeItem("numerosSorteados");
        localStorage.removeItem("ultimoNumero");
        actualizarUltimosTresAdmin([]);
        renderNotifs();
    }
});
</script>

<script>
/* ============================================================================
   FUNCIONES PARA MOSTRAR JUGADORES
   - mostrarJugadoresConectados(players) : muestra la lista real que manda el servidor
   - cargarJugadoresEnEspera() : mantiene la compatibilidad con localStorage (sin tocar)
============================================================================ */

function mostrarJugadoresConectados(players) {
    const box = document.getElementById("jugadoresEspera");
    if (!box) return;

    box.innerHTML = "";

    if (!players || players.length === 0) {
        box.innerHTML = `<p class="text-muted">No hay jugadores conectados.</p>`;
        return;
    }

    players.forEach(key => {
        const nombre = String(key).replace("player_", "").replace(/_/g, " ");

        const div = document.createElement("div");
        div.className = "p-3 mb-2 bg-dark rounded border border-secondary";

        div.innerHTML = `
            <div class="row align-items-center">
                <div class="col-md-8">
                    <strong style="font-size:18px">${nombre}</strong>
                    <div style="font-size:12px;color:#bbb;">Conectado ‚Äî esperando asignaci√≥n</div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-sm btn-primary" onclick="preAsignar('${key}')">Asignar</button>
                </div>
            </div>
        `;

        box.appendChild(div);
    });
}

// Funci√≥n auxiliar para abrir un prompt y asignar cartones r√°pido al jugador seleccionado
function preAsignar(playerKey) {
    const cant = parseInt(prompt("¬øCu√°ntos cartones asignar? (1-6)", "1"));
    if (!cant || cant < 1 || cant > 6) return alert("Cantidad inv√°lida.");
    asignarCartones(playerKey, false, cant);
}

/* ============================================================================
   CARGAR JUGADORES EN ESPERA (compatibilidad localStorage)
   Esta funci√≥n se mantiene para tu flujo actual; pero la lista en vivo
   viene desde mostrarJugadoresConectados(players).
============================================================================ */
function cargarJugadoresEnEspera() {
    const box = document.getElementById("jugadoresEspera");
    if (!box) return;
    box.innerHTML = "";

    Object.keys(localStorage).forEach(k => {
        if (!k.startsWith("player_")) return;
        try {
            const p = JSON.parse(localStorage.getItem(k) || "{}");

            // Solo mostrar NO aceptados
            if (p.aceptado !== true) {

                const div = document.createElement("div");
                div.className = "p-3 mb-2 bg-dark rounded border border-secondary";

                div.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-5">
                            <strong style="font-size:18px">${p.nombre}</strong>
                            <div style="font-size:12px;color:#bbb;">En espera</div>
                        </div>

                        <div class="col-md-3">
                            <input type="number" min="1" max="6" id="cant_${k}" 
                                   class="form-control form-control-sm"
                                   placeholder="Cartones">
                        </div>

                        <div class="col-md-4 text-end">
                            <button class="btn btn-success btn-sm"
                                    onclick="aceptarJugador('${k}')">
                                Aceptar
                            </button>
                        </div>
                    </div>
                `;

                box.appendChild(div);
            }
        } catch(e){}
    });
}
</script>

<script>
/* ============================================================================
   ACEPTAR JUGADOR
============================================================================ */
function aceptarJugador(key) {
    const p = JSON.parse(localStorage.getItem(key) || "{}");

    p.aceptado = true;
    p.asignado = false;
    p.cartonesRender = null;

    localStorage.setItem(key, JSON.stringify(p));
}


/* ============================================================================
   GENERAR CART√ìN CL√ÅSICO (90 bolillas)
============================================================================ */
function generarCartonClasico() {
    const carton = [[], [], []];

    for (let col = 0; col < 9; col++) {
        const min = col * 10 + 1;
        const max = col === 8 ? 90 : col * 10 + 10;

        const nums = [];
        while (nums.length < 3) {
            const n = Math.floor(Math.random() * (max - min + 1)) + min;
            if (!nums.includes(n)) nums.push(n);
        }
        nums.sort((a,b)=>a-b);
        for (let f=0; f<3; f++) carton[f][col] = nums[f];
    }

    // 4 casilleros vac√≠os por fila
    for (let f=0; f<3; f++){
        const idx = [0,1,2,3,4,5,6,7,8].sort(()=>Math.random()-0.5).slice(0,4);
        idx.forEach(i => carton[f][i] = null);
    }

    return carton;
}


/* ============================================================================
   PANEL NUEVO ‚Üí ACEPTADOS SIN CARTONES
============================================================================ */
function cargarAceptadosSinCartones() {
    const box = document.getElementById("aceptadosSinCartones");
    if (!box) return;

    box.innerHTML = "";

    Object.keys(localStorage).forEach(k => {
        if (!k.startsWith("player_")) return;
        const p = JSON.parse(localStorage.getItem(k) || "{}");

        if (p.aceptado === true && (!p.cartonesRender || p.asignado === false)) {

            const div = document.createElement("div");
            div.className = "p-3 mb-2 bg-dark rounded border border-secondary";

            div.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <strong style="font-size:18px">${p.nombre}</strong>
                        <div style="font-size:12px;color:#bbb;">Aceptado ‚Äî Sin cartones</div>
                    </div>

                    <div class="col-md-3">
                        <input type="number" min="1" max="6" id="asig_${k}"
                               class="form-control form-control-sm"
                               placeholder="Cartones">
                    </div>

                    <div class="col-md-4 text-end">
                        <button class="btn btn-primary btn-sm"
                            onclick="asignarCartones('${k}', true)">
                            Asignar cartones
                        </button>
                    </div>
                </div>
            `;

            box.appendChild(div);
        }
    });
}


/* ============================================================================
   ASIGNAR CARTONES  (VERSI√ìN CORREGIDA)
   - Si desdePanel==true toma el input del panel.
   - Si desdePanel==false y se pasa cantidad (tercero arg) la usa.
============================================================================ */
function asignarCartones(key, desdePanel = false, cantidadExtra = null) {
    const p = JSON.parse(localStorage.getItem(key) || "{}");

    if (!p.aceptado && !key.startsWith("player_")) {
        alert("Primero debes aceptar al jugador.");
        return;
    }

    // Obtener cantidad solicitada
    let cant;
    if (cantidadExtra !== null) {
        cant = parseInt(cantidadExtra);
    } else {
        const inputID = desdePanel ? "asig_" + key : "cant_" + key;
        const el = document.getElementById(inputID);
        if (!el) {
            // si no hay input (cuando viene por la lista del servidor), pedir prompt
            cant = parseInt(prompt("¬øCu√°ntos cartones asignar? (1-6)", "1"));
        } else {
            cant = parseInt(el.value);
        }
    }

    if (!cant || cant < 1 || cant > 6) {
        alert("Cantidad inv√°lida (1 a 6).");
        return;
    }

    // Generar cartones
    const lista = [];
    for (let i = 0; i < cant; i++) {
        lista.push(generarCartonClasico());
    }

    // Guardar local
    p.asignado = true;
    p.cartonesRender = lista;
    localStorage.setItem(key, JSON.stringify(p));

    // Enviar al servidor
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
            type: "assign-cartones",
            playerKey: key,
            cartones: lista
        }));
    }

    // Refrescar paneles
    cargarJugadoresEnEspera();
    cargarAceptadosSinCartones();
    cargarConCartones();

    alert("Cartones asignados correctamente.");
}


/* ============================================================================
   JUGADORES CON CARTONES
============================================================================ */
function cargarConCartones() {
    const cont = document.getElementById("conCartones");
    cont.innerHTML = "";

    Object.keys(localStorage).forEach(k => {
        if (!k.startsWith("player_")) return;
        const p = JSON.parse(localStorage.getItem(k) || "{}");

        if (p.asignado && p.cartonesRender) {
            const d = document.createElement("div");
            d.style.padding = "6px 8px";
            d.style.borderBottom = "1px solid rgba(255,255,255,0.03)";
            d.innerHTML = `<strong>${p.nombre}</strong> ‚Äî ${p.cartonesRender.length} cart√≥n(es)`;
            cont.appendChild(d);
        }
    });
}


/* ============================================================================
   REFRESH AUTOM√ÅTICO
============================================================================ */
setInterval(() => {

    // No refrescar si el admin est√° escribiendo dentro de un input
    const activo = document.activeElement;
    if (activo && activo.tagName === "INPUT") {
        return; // evita borrar lo que se est√° escribiendo
    }

    cargarJugadoresEnEspera();
    cargarAceptadosSinCartones();
    cargarConCartones();

}, 1200);


cargarJugadoresEnEspera();
cargarAceptadosSinCartones();
cargarConCartones();
// ============================================================
// PANEL DE REPORTES ‚Äî agrega los reportes en vivo del jugador
// ============================================================
function agregarReporteEnVivo(rep) {
    const panel = document.getElementById("panelReportes");

    // Si solo est√° el mensaje "A√∫n no hay reportes..." lo borramos
    if (panel.children.length === 1 && panel.children[0].tagName === "P") {
        panel.innerHTML = "";
    }

    const div = document.createElement("div");
    div.className = "reporteItem reporte-" + (rep.tipo||"info").toLowerCase();

    div.innerHTML = `
        <strong>${rep.tipo}</strong> ‚Äî 
        Jugador <b>${rep.jugador}</b><br>
        Cart√≥n: ${rep.cartonIndex + 1}
        ${rep.filaIndex !== null && rep.filaIndex !== undefined ? " ‚Äî Fila: " + (rep.filaIndex + 1) : ""}
        <br>
        <small>${new Date().toLocaleTimeString()}</small>
    `;

    // Insertar primero (reportes recientes arriba)
    panel.prepend(div);
}
</script>



<!-- ====================================================================================
     NOTIFICACIONES + SORTEO (SE MANTIENE TAL CUAL ‚Äî NO SE MODIFIC√ì NADA)
==================================================================================== -->
<script>
function idEl(id){ return document.getElementById(id); }
function leerNotifs(){ try { return JSON.parse(localStorage.getItem("notificaciones")||"[]"); } catch(e){ return []; } }
function escribirNotifs(a){ localStorage.setItem("notificaciones", JSON.stringify(a)); }

function actualizarUltimosTresAdmin(arr) {
    const cont = idEl("numerosAnim");
    [...cont.children].forEach(c=>{ c.classList.add("fadeOut"); setTimeout(()=>c.remove(),300); });
    const ult = arr.slice(-3);
    setTimeout(()=>{
        ult.forEach(num=>{
            const d = document.createElement("div");
            d.textContent = num;
            d.style.fontSize = "36px";
            d.style.color = "#ffc107";
            d.style.opacity = "0";
            d.style.transform = "scale(.5)";
            d.style.transition = "all .35s";
            cont.appendChild(d);
            setTimeout(()=>{ d.style.opacity = "1"; d.style.transform = "scale(1)"; },60);
        });
    },350);
}

function renderNotifs() {
    const list = idEl("notifsList");
    list.innerHTML = "";
    const arr = leerNotifs().slice().reverse();

    arr.forEach(n=>{
        const div = document.createElement("div");
        div.className = "notif";

        const left = document.createElement("div");
        left.innerHTML = `<div style="font-weight:bold">${n.mensaje}</div>
                          <div style="font-size:12px;color:#ccc">${new Date(n.ts).toLocaleTimeString()}</div>`;

        const right = document.createElement("div");
        
        const tipo = document.createElement("span");
        tipo.className = "badge bg-warning text-dark badgeTipo";
        tipo.textContent = n.tipo;

        const btn = document.createElement("button");
        btn.className = "btn btn-sm btn-light btnSmall";
        btn.textContent = "Aceptar";
        btn.onclick = ()=> aceptarNotif(n.id);

        right.appendChild(tipo);
        right.appendChild(btn);

        div.appendChild(left);
        div.appendChild(right);

        list.appendChild(div);
    });

    const arrNums = JSON.parse(localStorage.getItem("numerosSorteados")||"[]");
    idEl("numeroActual").textContent = arrNums.length? arrNums.slice(-1)[0] : "--";
}

function aceptarNotif(id) {
    const arr = leerNotifs();
    const idx = arr.findIndex(x=>x.id===id);
    if (idx === -1) return;
    arr[idx].visto = true;
    escribirNotifs(arr);
    renderNotifs();
}

function limpiarNotifs(){
    let arr = leerNotifs();
    arr = arr.filter(n => !n.visto);
    escribirNotifs(arr);
    renderNotifs();
}

window.addEventListener('storage', (e)=>{
    if (e.key === "notificaciones" || e.key === "numerosSorteados") {
        const arr = JSON.parse(localStorage.getItem("numerosSorteados")||"[]");
        if (arr.length) actualizarUltimosTresAdmin(arr);
        renderNotifs();
    }
});

(function init(){
    const arrNums = JSON.parse(localStorage.getItem("numerosSorteados")||"[]");
    if (arrNums.length) actualizarUltimosTresAdmin(arrNums);
    renderNotifs();
})();
</script>

<script>
/* ============================================================
   FUNCIONES FALTANTES: SACAR N√öMERO + REINICIAR
   (NO MODIFICADAS respecto a tu versi√≥n original)
============================================================ */

// Obtener lista completa del 1 al 90
function getBolillero() {
    const arr = [];
    for (let i = 1; i <= 90; i++) arr.push(i);
    return arr;
}

function sacarNumero(){
    let arr = JSON.parse(localStorage.getItem("numerosSorteados") || "[]");

    if (arr.length >= 90) { 
        alert("Ya salieron todos los n√∫meros.");
        return; 
    }

    let n;
    do {
        n = Math.floor(Math.random() * 90) + 1;
    } while (arr.includes(n));

    // Enviar al servidor
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
            type: "new-number",
            number: n
        }));
    }

    arr.push(n);

    localStorage.setItem("numerosSorteados", JSON.stringify(arr));
    localStorage.setItem("ultimoNumero", n);

    document.getElementById("numeroActual").textContent = n;

    actualizarUltimosTresAdmin(arr);
}

function reiniciarSorteo() {
    if (!confirm("¬øReiniciar el sorteo? Se borrar√°n todos los n√∫meros.")) return;

    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "reset-numbers" }));
    }

    localStorage.removeItem("numerosSorteados");
    localStorage.removeItem("ultimoNumero");

    document.getElementById("numeroActual").textContent = "--";
    actualizarUltimosTresAdmin([]);
}
</script>

</body>
</html>
